# Archer 射手实体实现文档

## 概述

Archer（射手）是一个远程攻击单位，具有以下行为特征：

## 行为逻辑

### 1. 核心参数

- **攻击距离 (a)**: 5格 - 射手的远程攻击范围
- **危险距离 (b)**: 2格 - 当敌人进入此距离时，射手会逃跑
- **逃跑距离**: 4格 - 每次逃跑移动的距离
- **探测范围**: 15格 - 射手能够发现敌人的范围

### 2. 属性配置

- **生命值**: 80 (较低，脆皮单位)
- **攻击力**: 20 (较高，远程高伤害)
- **移动速度**: 3.0 (中等速度)
- **攻击冷却**: 2秒

### 3. 行为优先级

射手的行为树按以下优先级执行：

```
逃跑 > 攻击 > 寻找敌人 > 待机
```

#### 优先级1：逃跑行为
- **触发条件**: 存活 + 有目标 + 目标在危险区域内（距离 ≤ 2格）
- **执行动作**: 计算远离敌人的方向，移动4格距离
- **重要限制**: 攻击中或受击硬直时无法立刻执行逃跑

#### 优先级2：攻击行为
- **触发条件**: 存活 + 有目标 + 目标在攻击范围内（距离 ≤ 5格）+ CD冷却完毕
- **执行动作**: 远程攻击目标

#### 优先级3：寻找敌人
- **触发条件**: 没有当前目标
- **执行动作**: 在探测范围内查找最近的敌人（Chaser）

#### 优先级4：待机
- **执行动作**: 保持空闲状态

## 实现细节

### 关键限制

1. **攻击时无法逃跑**: 由`CombatComponent.CanMove`属性控制，攻击状态机运行时返回false
2. **受击硬直时无法逃跑**: 受击后进入硬直状态，`CanMove`同样返回false
3. **只有完全空闲时才能执行逃跑**: 确保`AttackState == Idle && HitState == None`

### 新增节点

#### 1. CheckDangerZoneNode (条件节点)
- **位置**: `EntityModule.BehaviorTree.Nodes.Condition`
- **功能**: 检查目标是否进入危险区域
- **参数**: `dangerRange` - 危险距离阈值
- **返回**: Success（目标在危险区域内）/ Failure（安全）

#### 2. FleeFromTargetNode (行动节点)
- **位置**: `EntityModule.BehaviorTree.Nodes.Action`
- **功能**: 从目标逃跑，计算远离方向并移动
- **参数**: `fleeDistance` - 逃跑距离
- **特性**:
  - 自动计算远离敌人的方向
  - 验证逃跑目标位置是否可走
  - 如果目标不可走，搜索附近可走的格子
  - 缓存逃跑位置，避免重复计算

#### 3. FindEnemyNode (行动节点)
- **位置**: `EntityModule.BehaviorTree.Nodes.Action`
- **功能**: 通用敌人查找节点
- **特性**:
  - 支持不同实体类型的敌对关系判定
  - Archer的敌人是Chaser
  - 在探测范围内查找最近的存活敌人

### 实体类型扩展

在 `EntityType.cs` 中添加：
```csharp
Archer = 2  // 射手
```

### 注册方式

在 `GameInitializer.cs` 中通过 `RegisterArcher()` 方法注册：
- 使用注册表模式（Registry Pattern）
- 支持Mod扩展和后处理钩子
- 符合开闭原则

## 测试方式

1. 在Unity编辑器中找到包含 `EntitySystemTest` 组件的GameObject
2. 在Inspector中配置：
   - `archerCount`: 设置要创建的射手数量
   - `archerStartPos`: 设置射手的初始位置
3. 运行游戏或在Inspector中点击右键菜单 "创建测试实体"

## 战术特点

1. **风筝战术**: 射手会在敌人靠近时后撤，保持攻击距离
2. **远程输出**: 5格的攻击距离让射手能够安全输出
3. **脆皮定位**: 80生命值意味着射手需要依靠走位避免被近战单位接近
4. **高爆发**: 20点攻击力配合2秒CD，伤害输出可观

## 架构遵循

本实现完全遵循项目的架构要求：

1. ✅ **MVC模式**: 数据、逻辑、表现分离
2. ✅ **组合优于继承**: Entity只是组件容器
3. ✅ **注册表模式**: 支持灵活的实体定义和Mod扩展
4. ✅ **迪米特法则**: 节点只与必要的组件交互
5. ✅ **单一职责原则**: 每个节点职责明确
6. ✅ **开闭原则**: 通过注册而非修改源码扩展实体

## 未来扩展

1. **配置表支持**: 可将数值参数移到Luban配置表
2. **专用预制体**: 为Archer创建独特的视觉表现
3. **多种逃跑策略**: 如向友军方向逃跑、向掩体逃跑等
4. **技能系统**: 添加特殊技能，如爆头、穿透箭等

